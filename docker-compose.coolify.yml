################################################################################
# Practix Backend + Judge0 Stack for Coolify
#
# This compose file is designed to be deployed as a single stack in Coolify,
# ensuring backend and Judge0 are on the same Docker network.
#
# Usage in Coolify:
# 1. Create a new Docker Compose resource
# 2. Point to this file: docker-compose.coolify.yml
# 3. Set required environment variables in Coolify
#
# Required environment variables:
# - DATABASE_URL: PostgreSQL connection string
# - JWT_SECRET: Secret for JWT tokens
# - GEMINI_API_KEY: (optional) For AI Tutor
# - REDIS_HOST: Redis hostname
# - REDIS_PORT: Redis port (usually 6379)
################################################################################

services:
  ##############################################################################
  # Judge0 Code Execution Engine
  # Fast, reliable code execution with native ARM64 support
  ##############################################################################
  judge0-server:
    image: judge0/judge0:1.13.1
    container_name: practix_judge0
    restart: always
    ports:
      - "2358:2358"
    privileged: true
    environment:
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0_secure_password}
      - REDIS_HOST=judge0-redis
      - REDIS_PORT=6379
      - ENABLE_WAIT_RESULT=true
      - ENABLE_BATCHED_SUBMISSIONS=true
      - MAX_QUEUE_SIZE=100
      - CPU_TIME_LIMIT=30
      - CPU_EXTRA_TIME=5
      - WALL_TIME_LIMIT=60
      - MEMORY_LIMIT=512000
      - STACK_LIMIT=64000
      - MAX_PROCESSES_AND_OR_THREADS=60
      - ENABLE_PER_PROCESS_AND_THREAD_TIME_LIMIT=false
      - ENABLE_PER_PROCESS_AND_THREAD_MEMORY_LIMIT=false
      - MAX_FILE_SIZE=2048
      - NUMBER_OF_RUNS=1
      - ENABLE_NETWORK=false
    depends_on:
      judge0-db:
        condition: service_healthy
      judge0-redis:
        condition: service_healthy
    mem_limit: 2g
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2358/languages"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - practix-network

  judge0-workers:
    image: judge0/judge0:1.13.1
    container_name: practix_judge0_workers
    restart: always
    command: ["./scripts/workers"]
    privileged: true
    environment:
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=${JUDGE0_DB_PASSWORD:-judge0_secure_password}
      - REDIS_HOST=judge0-redis
      - REDIS_PORT=6379
      - ENABLE_WAIT_RESULT=true
      - CPU_TIME_LIMIT=30
      - CPU_EXTRA_TIME=5
      - WALL_TIME_LIMIT=60
      - MEMORY_LIMIT=512000
      - NUMBER_OF_RUNS=1
    depends_on:
      judge0-server:
        condition: service_healthy
    mem_limit: 4g
    networks:
      - practix-network

  judge0-db:
    image: postgres:15-alpine
    container_name: practix_judge0_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: ${JUDGE0_DB_PASSWORD:-judge0_secure_password}
      POSTGRES_DB: judge0
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U judge0 -d judge0"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 10s
    networks:
      - practix-network

  judge0-redis:
    image: redis:7-alpine
    container_name: practix_judge0_redis
    restart: unless-stopped
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - judge0_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - practix-network

  ##############################################################################
  # Backend API Server
  ##############################################################################
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/your-org/practix-backend:latest}
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: practix_backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database (set in Coolify)
      DATABASE_URL: ${DATABASE_URL}
      # Auth
      JWT_SECRET: ${JWT_SECRET}
      # AI Tutor
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      # Server
      PORT: 8080
      NODE_ENV: production
      SKIP_SEED: ${SKIP_SEED:-false}
      # Judge0 - uses container name on shared network
      JUDGE0_URL: http://judge0-server:2358
      # Redis (set in Coolify)
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Security
      ENABLE_IP_BAN: ${ENABLE_IP_BAN:-true}
      SUSPICIOUS_ACTIVITY_LOG: ${SUSPICIOUS_ACTIVITY_LOG:-true}
      MALICIOUS_CODE_CHECK: ${MALICIOUS_CODE_CHECK:-true}
      IP_BAN_THRESHOLD: ${IP_BAN_THRESHOLD:-10}
      IP_BAN_DURATION_HOURS: ${IP_BAN_DURATION_HOURS:-24}
      # Rate Limiting (seconds between runs)
      RATE_LIMIT_RUN_FREE: ${RATE_LIMIT_RUN_FREE:-10}
      RATE_LIMIT_RUN_AUTH: ${RATE_LIMIT_RUN_AUTH:-5}
      RATE_LIMIT_RUN_PREMIUM: ${RATE_LIMIT_RUN_PREMIUM:-3}
      RATE_LIMIT_REGISTER: ${RATE_LIMIT_REGISTER:-3}
      RATE_LIMIT_LOGIN: ${RATE_LIMIT_LOGIN:-5}
    depends_on:
      judge0-server:
        condition: service_healthy
    command: >
      sh -c "until npx prisma db push; do echo 'Waiting for Postgres...'; sleep 5; done &&
      if [ \"$SKIP_SEED\" != \"true\" ]; then npm run seed || true; fi &&
      node dist/main"
    networks:
      - practix-network

networks:
  practix-network:
    driver: bridge

volumes:
  judge0_postgres_data:
  judge0_redis_data:
